<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width" />
    <style type="text/css">
      html, body {
        height: 100%;
        margin: 0;
        pad: 0;
      }
      #map {
        width: 100%;
        height: 100%;
      }
      .map-marker {
        width: initial;
        height: initial;
        overflow: visible !important;
      }
      .map-marker .map-label-marker-content-container {
        position: relative;
        display: inline-block;
        margin-top: -8px;
      }
      .map-marker .tooltip-content {
        font-size: 15px;
        line-height: 18px;
        letter-spacing: 0.2px;
        padding: 4px 5px 4px 6px;
        color: #222222;
        font-weight: 700;
        background: #ffffff;
        border: 1px solid rgba(0, 0, 0, 0.2);
        box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.15);
        border-radius: 2px;
        position: relative;
      }
      .map-marker .tooltip-bottom-arrow {
        border-color: rgba(0, 0, 0, 0.2);
        border-style: solid;
        border-width: 0 1px 1px 0;
        bottom: -4px;
        left: 50%;
        margin-left: -4px;
        background-color: #ffffff;
        width: 8px;
        height: 8px;
        -webkit-transform: rotate(45deg);
        transform: rotate(45deg);
        position: absolute;
      }
      .map-marker .tooltip-content >div {
        display: table-cell;
        vertical-align: middle;
      }
      .marker-selected {
        z-index: 10000 !important;
      }
      .marker-selected .tooltip-content {
        background-color: #006C70;
        color: white;
      }
      .marker-selected .tooltip-bottom-arrow {
        background-color: #006C70;
      }
      .marker-selected svg {
        fill: currentColor !important;
      }
    </style>
    <script type="text/javascript">
      function setupMockBridge() {
        if (!window.webkit || !window.webkit.messageHandlers) {
          window.mapBridge = {
            lastSelectedIndex: -1,
            onMapLoaded: function() {
              console.log("loaded");
              window.mapApp.reloadLabelMarkers([{ "lat": 31.207765109208133, "lng": 121.46358948058823, "content": "123" }, { "lat": 31.245707148449764, "lng": 121.49010774242592, "content": "123" }, { "lat": 31.231076130274545, "lng": 121.47789099165209, "content": "123" }, { "lat": 31.209672267177126, "lng": 121.49653792367261, "content": "123" }, { "lat": 31.204453948556974, "lng": 121.45256974333431, "content": "123" }, { "lat": 31.250417282414883, "lng": 121.48424491274733, "content": "123" }, { "lat": 31.17551593691849, "lng": 121.49021234532792, "content": "123" }, { "lat": 31.213314082196728, "lng": 121.45287242807854, "content": "123" }, { "lat": 31.221354244917894, "lng": 121.45376792107803, "content": "123" }, { "lat": 31.207765109208133, "lng": 121.46358948058823, "content": "123" }, { "lat": 31.244706946789293, "lng": 121.48864368802441, "content": "123" }, { "lat": 31.214846062964153, "lng": 121.48841889790093, "content": "123" }, { "lat": 31.225631470461039, "lng": 121.46214586592865, "content": "123" }, { "lat": 31.278789810819703, "lng": 121.50116069513983, "content": "123" }, { "lat": 31.246514220376248, "lng": 121.48949332182285, "content": "123" }, { "lat": 31.236582535154106, "lng": 121.52410945256688, "content": "123" }, { "lat": 31.234220453869458, "lng": 121.48188265929122, "content": "123" }, { "lat": 31.25237438609825, "lng": 121.56982596721066, "content": "123" }, { "lat": 31.253351390821521, "lng": 121.48915540758766, "content": "123" }, { "lat": 31.132013442628541, "lng": 121.57188970723446, "content": "123" }]);
              window.mapApp.zoomToFitAnnotations();
            },
            onLabelMarkerClicked: function(index) {
              console.log("clicked label marker " + index);
              if (this.lastSelectedIndex != -1) {
                window.mapApp.deselectMarker(this.lastSelectedIndex);
              }
              this.lastSelectedIndex = index;
              window.mapApp.selectMarker(index);
            },
            onMapClick: function() {
              console.log("click");
            },
            onMapBoundsChanged: function(centerLat, centerLng, spanLat, spanLng) {
              //console.log("bounds changed " + centerLat + " " +centerLat + " " + spanLat + " " + spanLng);
              //console.log("bounds message");
            },
            onMapIdle: function(userInteraction) {
              console.log("onMapIdle, "+ userInteraction);
            }
          };
        } else {
          window.mapBridge = {
            onMapLoaded: function() {
              window.webkit.messageHandlers.GoogleMapWebApp.postMessage({'name': 'onMapLoaded'})
            },
            onLabelMarkerClicked: function(index) {
              window.webkit.messageHandlers.GoogleMapWebApp.postMessage({'name': 'onLabelMarkerClicked', 'params': {'index': index}})
            },
            onMapClick: function() {
              console.log("onMapClick");
              window.webkit.messageHandlers.GoogleMapWebApp.postMessage({'name': 'onMapClick'});
            },
            // This will be fire whenever bounds is changed
            onMapBoundsChanged: function(centerLat, centerLng, spanLat, spanLng) {
              window.webkit.messageHandlers.GoogleMapWebApp.postMessage({'name': 'onMapBoundsChanged', 'params': {
                                                                        'centerLat': centerLat,
                                                                        'centerLng': centerLng,
                                                                        'spanLat': spanLat,
                                                                        'spanLng': spanLng}})
            },
            onMapIdle: function(userInteraction) {
              window.webkit.messageHandlers.GoogleMapWebApp.postMessage({'name': 'onMapIdle', 'params': {'userInteraction': userInteraction}});
            }
          };
        }
      };

      function initMap() {
        setupMockBridge();

        var map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: -34.397, lng: 150.644},
          zoom: 15,
          disableDefaultUI: true,
          clickableIcons: false
        });

        var didStartUserInteraction = false;

        google.maps.event.addListener(map, 'bounds_changed', function() {
          var bounds = map.getBounds();
          var center = bounds.getCenter();
          var span = bounds.toSpan();
          window.mapBridge.onMapBoundsChanged(center.lat(), center.lng(), span.lat(), span.lng());
        });
        google.maps.event.addListener(map, 'dragstart', function() {
          didStartUserInteraction = true;
        });
        google.maps.event.addListener(map, 'click', function(e) {
          console.log("haha click");
          console.log(e);
          window.mapBridge.onMapClick();
        });
        google.maps.event.addListener(map, 'dblclick', function() {
          didStartUserInteraction = true;
        });
        google.maps.event.addListener(map, 'idle', function() {
          window.mapBridge.onMapIdle(didStartUserInteraction);
          didStartUserInteraction = false;
        });

        window.mapApp = {
          map: map,
          markers: [],
          MarkerWithLabel: generateMarkerWithLabel(google),

          updateRegion: function(swLat, swLng, neLat, neLng) {
            /*var swLatLng = new google.maps.LatLng(swLat, swLng);
            var neLatLng = new google.maps.LatLng(neLat, neLng);
            this.map.fitBounds(new google.maps.LatLngBounds(swLatLng, neLatLng));*/
          },

          clearMarkers: function() {
            for (var idx in self.markers) {
              +this.markers[idx].setMap(null);
            }
            this.markers = [];
            this.map.setZoom(this.map.getZoom() + 1);
            this.map.setZoom(this.map.getZoom() - 1);
          },

          reloadLabelMarkers: function(markers) {
            this.clearMarkers();

            var createLabelMarker = function(index) {
              var newNode = document.getElementById("map-label-marker-content-template").cloneNode(true);
              newNode.querySelector('.tooltip-content').innerHTML = markers[index].content;
              var position = new google.maps.LatLng(markers[index].lat, markers[index].lng);
              var marker = new this.MarkerWithLabel({
                position: position,
                map: this.map,
                draggable: false,
                labelContent: newNode.innerHTML,
                labelClass: 'map-marker',
                icon: { path: google.maps.SymbolPath.CIRCLE, scale: 0 },
              });
              this.markers.push(marker);

              google.maps.event.addListener(marker, 'click', function() {
                window.mapBridge.onLabelMarkerClicked(index);
              });
            }.bind(this);

            for (var idx in markers) {
              createLabelMarker(idx);
            }
          },

          selectMarker: function(index) {
            this.markers[index].setOptions({
              labelClass: 'map-marker marker-selected'
            });
          },

          deselectMarker: function(index) {
            this.markers[index].setOptions({
              labelClass: 'map-marker'
            });
          },

          zoomToFitAnnotations: function() {
            didStartUserInteraction = false;
            var bounds = new google.maps.LatLngBounds();
            for (var i = 0; i < this.markers.length; i++) {
              bounds.extend(this.markers[i].getPosition());
            }
            this.map.fitBounds(bounds);
          },

          setCenter: function(lat, lng) {
            didStartUserInteraction = false;
            map.setCenter({lat: lat, lng: lng});
          }
        };

        window.mapBridge.onMapLoaded();
      }
    </script>
  </head>
  <body>
      <div id="map-label-marker-content-template" style="display: none;">
        <div class="map-label-marker-content-container">
          <div class="tooltip-content">
          </div>
          <div class="tooltip-bottom-arrow"></div>
        </div>
      </div>
    <div id="map"></div>
    <script src="generateMarkerWithLabel.js"></script>
    <script src="https://ditu.google.cn/maps/api/js?sensor=true&language=zhCN&callback=initMap"></script>
  </body>
</html>
